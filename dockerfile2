FROM ghcr.io/linuxserver/baseimage-alpine:3.12

ARG XMLTV_VER="v1.0.0"

# set version label
ARG BUILD_DATE
ARG VERSION
LABEL build_version="Linuxserver.io version:- ${VERSION} Build-date:- ${BUILD_DATE}"
LABEL maintainer="noone"

# environment settings
ENV HOME="/config"

RUN \
 echo "**** install build packages ****" && \
 apk add --no-cache \
	curl \
	git \
	gzip \
	make \
  perl \
  perl-archive-zip \
  perl-cgi \
  perl-data-dump \
  perl-date-calc \
  perl-date-manip \
  perl-datetime \
  perl-datetime-format-iso8601 \
  perl-datetime-format-sqlite \
  perl-datetime-format-strptime \
  perl-dbd-sqlite \
  perl-dbi \
  perl-file-chdir \
  perl-file-homedir \
  perl-file-slurp \
  perl-file-which \
  perl-html-parser \
  perl-html-tree \
  perl-http-cache-transparent \
  perl-http-cookies \
  perl-http-message \
  perl-io-stringy \
  perl-json \
  perl-json-xs \
  perl-libwww-perl \
  perl-lingua-preferred \
  perl-list-moreutils \
  perl-log-tracemessages \
  perl-lwp-protocol-https \
  perl-lwp-useragent-determined \
  perl-perlio-gzip \
  perl-soap-lite \
  perl-term-progressbar \
  perl-termreadkey \
  perl-timedate \
  perl-tk \
  perl-tk-tablematrix \
  perl-try-tiny \
  perl-unicode-string \
  perl-uri \
  perl-uri-encode \
  perl-xml-dom \
  perl-xml-libxml \
  perl-xml-libxslt \
  perl-xml-parser \
  perl-xml-simple \
  perl-xml-treepp \
  perl-xml-twig \
  perl-xml-writer \
	tar 

RUN \
 echo "**** install perl modules for xmltv ****" && \
 curl -s -L https://cpanmin.us | perl - App::cpanminus && \
 cpanm --installdeps /tmp/patches

  RUN \
 echo "**** compile XMLTV ****" && \
 git clone https://github.com/XMLTV/xmltv.git /tmp/xmltv && \
 cd /tmp/xmltv && \
 git checkout ${XMLTV_VER} && \
 echo "**** Perl 5.26 fixes for XMTLV ****" && \
 sed "s/use POSIX 'tmpnam';//" -i filter/tv_to_latex && \
 sed "s/use POSIX 'tmpnam';//" -i filter/tv_to_text && \
 sed "s/\(lib\/set_share_dir.pl';\)/.\/\1/" -i grab/it/tv_grab_it.PL && \
 sed "s/\(filter\/Grep.pm';\)/.\/\1/" -i filter/tv_grep.PL && \
 sed "s/\(lib\/XMLTV.pm.in';\)/.\/\1/" -i lib/XMLTV.pm.PL && \
 sed "s/\(lib\/Ask\/Term.pm';\)/.\/\1/" -i Makefile.PL && \
 PERL5LIB=`pwd` && \
 echo -e "yes" | perl Makefile.PL PREFIX=/usr/ INSTALLDIRS=vendor && \
 make -j 2 && \
 make test && \
 make DESTDIR=/tmp/xmltv-build install

 VOLUME /config

 #test